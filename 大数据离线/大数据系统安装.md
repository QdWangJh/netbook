# centos7 大数据平台系统化安装

基础环境:

三台Centos7的虚拟机node1,node2,node3

以nat方式组网,在同一网段中并且都可互相访问.

目录介绍:

/export/server #软件安装目录

 /export/software #安装包的目录

 /export/data #软件运行数据保存的目录

 /export/logs  



## Linux基础安装

### 一 JDK 安装

1. #上传安装包到/export/server 下

2. \#解压到当前目录 

   tar zxvf jdk-8u65-linux-x64.tar.gz

3. \#配置环境变量

    vim /etc/profile			 #G + o 

   export JAVA_HOME=/export/server/jdk1.8.0_65 

   export PATH=$PATH:$JAVA_HOME/bin 

   export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar

4. \#重新加载环境变量文件 让配置生效

   source /etc/profile

5. #验证

[root@node1 ~]# java -version  

java version "1.8.0_65" Java(TM) SE Runtime Environment (build 1.8.0_65-b17) Java HotSpot(TM) 64-Bit Server VM (build 25.65-b01, mixed mode)



### 二 MySql 安装

1. #创建安装目录

   mkdir /export/software/mysql

2. #上传文件并解压

   tar xvf mysql-5.7.29-1.el7.x86_64.rpm-bundle.tar

3. #执行安装

   yum -y install libaio

   rpm -ivh mysql-community-common-5.7.29-1.el7.x86_64.rpm  mysql-community-libs-5.7.29-1.el7.x86_64.rpm mysql-community-client-5.7.29-1.el7.x86_64.rpm  mysql-community-server-5.7.29-1.el7.x86_64.rpm 

4. #初始化

   mysqld --initialize

5. \#更改所属组

   chown mysql:mysql /var/lib/mysql -R

6. \#启动 mysql服务

   systemctl start mysqld.service

7. 查看生成的临时 root 密码

   cat /var/log/mysqld.log

   [Note] A temporary password is generated for root@localhost: **o+TU+KDOm004**

8. #修改密码

   [root@node2 ~]# mysql -u root -p

   Enter password:     #这里输入在日志中生成的临时密码

   \#更新 root 密码 设置为 hadoop 

   mysql> alter user user() identified by "hadoop";

9. #授权远程访问

   mysql> use mysql; 

   mysql> GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'hadoop' WITH GRANT OPTION; 

   mysql> FLUSH PRIVILEGES;

10. #设置为开机自启动

    [root@node2 ~]# systemctl enable mysqld 

    Created symlink from /etc/systemd/system/multi-user.target.wants/mysqld.service to  /usr/lib/systemd/system/mysqld.service.

11. #查看是否设置成功

    [root@node2 ~]# systemctl list-unit-files | grep mysqld 

    mysqld.service enabled

\#mysql 的启动和关闭 状态查看 

systemctl start mysqld

systemctl stop mysqld 

systemctl status mysqld 



#### 附:卸载MySql

\#关闭 mysql 服务

systemctl stop mysqld.service



\#查找安装 mysql 的 rpm 包 

[root@node3 ~]# rpm -qa | grep -i mysql  

mysql-community-libs-5.7.29-1.el7.x86_64 

mysql-community-common-5.7.29-1.el7.x86_64 

mysql-community-client-5.7.29-1.el7.x86_64 

mysql-community-server-5.7.29-1.el7.x86_64



\#卸载 [root@node3 ~]# yum remove mysql-community-libs-5.7.29-1.el7.x86_64  mysql-community-common-5.7.29-1.el7.x86_64 mysql-community-client-5.7.29-1.el7.x86_64  mysql-community-server-5.7.29-1.el7.x86_64



\#查看是否卸载干净 

rpm -qa | grep -i mysql



\#查找 mysql 相关目录 删除

[root@node1 ~]# find / -name mysql 

/var/lib/mysql 

/var/lib/mysql/mysql 

/usr/share/mysql



[root@node1 ~]# rm -rf /var/lib/mysql 

[root@node1 ~]# rm -rf /var/lib/mysql/mysql 

[root@node1 ~]# rm -rf /usr/share/mysql



\#删除默认配置 日志 

rm -rf /etc/my.cnf  

rm -rf /var/log/mysqld.log



### 三 修改网络配置

1. 修改主机名  /主机名修改后需要 reboot 重启生效

   vim /etc/hostname

2. 修改 IP 地址

   vim /etc/sysconfig/network-scripts/ifcfg-ens33

TYPE="Ethernet" #网卡类型 以太网 

PROXY_METHOD="none" 

BROWSER_ONLY="no" 

BOOTPROTO="none" # ip地址获取模式 none和static为手动获取DHCP为自动获取

DEFROUTE="yes" 

IPV4_FAILURE_FATAL="no" 

IPV6INIT="yes" 

IPV6_AUTOCONF="yes" 

IPV6_DEFROUTE="yes" 

IPV6_FAILURE_FATAL="no" 

IPV6_ADDR_GEN_MODE="stable-privacy" 

NAME="ens33" #网卡名称 

UUID="74c3b442-480d-4885-9ffd-e9f0087c9cf7" 

DEVICE="ens33" 

ONBOOT="yes" #是否开机启动网卡服务 

IPADDR="192.168.227.152" #IP 地址 

PREFIX="24" #子网掩码 等效: NETMASK=255.255.255.0 GATEWAY="192.168.227.2" #网关服务 

DNS1="192.168.227.2" #网关 DNS 解析 

DOMAIN="114.114.114.114" #公网 DNS 解析 114.114.114.114  

DNS IPV6_PRIVACY="no



3. 重启网络服务

   systemctl restart network

   重启虚拟机后**有可能**会遇到连接失败,网络配置文件内容正确,但获取的地址有问题,可以重启网络服务,重新获取后 一般可以解决.

4. 主机名和ip映射  /未做映射只能用IP访问,做完映射后可以用主机名来代替IP访问

   * linux上

     * vim /etc/hosts

     * 127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
       ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

       **192.168.227.151 node1.itcast.cn node1**
       **192.168.227.152 node2.itcast.cn node2**
       **192.168.227.153 node3.itcast.cn node3**

       #IP  主机名  简称

   * windows

     * C:\Windows\System32\drivers\etc\hosts

     * **192.168.227.151 node1.itcast.cn node1**
       **192.168.227.152 node2.itcast.cn node2**
       **192.168.227.153 node3.itcast.cn node3**

### 四 关闭防火墙

   * firewalld防火墙

     * #查看防火墙状态
       systemctl status firewalld

       #关闭防火墙
       systemctl stop firewalld

       #关闭防火墙开机自启动
       systemctl disable firewalld

   * selinux

     * vim /etc/selinux/config

     * ```shell
       # This file controls the state of SELinux on the system.
       # SELINUX= can take one of these three values:
       #     enforcing - SELinux security policy is enforced.
       #     permissive - SELinux prints warnings instead of enforcing.
       #     disabled - No SELinux policy is loaded.
       SELINUX=disabled
       ```

   ------需要重启生效 reboot



### 五 集群时间同步

#查看当前系统时间

date

#ntpdate 授时服务器授时

ntpdate ntp5.aliyun.com



##企业中运维一般不适用ntpdate,因为这个命令同步时间是立即的,不是平滑过渡的.

​	可以使用ntp软件进行授时



### 六 集群 ssh 免密登录

1. 在node1生成公钥

   ssh-keygen   #在当前用户的home下生成公钥的隐藏文件

   [root@node1 .ssh]# pwd
   /root/.ssh
   [root@node1 .ssh]# ll

   total 12
   -rw------- 1 root root 1675 May 20 11:59 id_rsa
   -rw-r--r-- 1 root root  402 May 20 11:59 id_rsa.pub
   -rw-r--r-- 1 root root  183 May 20 11:50 known_hosts

2. copy公钥给node2

   ssh-copy-id node2

##第一次登陆时需要密码

#### 附:跨机器拷贝

```shell
#本地copy其他机器
scp itcast.txt root@node2:/root/

scp -r linux02/ root@node2:$PWD   #copy文件夹 -r参数   $PWD copy至和本机相同当前路径

#copy其他机器文件到本地
scp root@node2:/root/itcast.txt  ./  
```


# Apache  ZooKeeper 分布式小文件存储系统

 zk集群在搭建部署的时候，通常选择==**2n+1**==奇数台。底层 Paxos 算法支持（过半成功）。

安装要求:**IP\主机名\hosts映射\防火墙关闭\时间同步\ssh免密登录\JDK成功安装**

1. 上传  解压  重命名

   ```shell
   cd /export/server
   --上传--
   tar zxvf zookeeper-3.4.6.tar.gz
   mv zookeeper-3.4.6/ zookeeper
   ```

   2.修改配置文件

   * zoo.cdg

     ```shell
     #zk默认加载的配置文件是zoo.cfg 因此需要针对模板进行修改。保证名字正确。
     cd zookeeper/conf
     mv zoo_sample.cfg zoo.cfg
     
     vi zoo.cfg
     
     #修改
     dataDir=/export/data/zkdata
     #文件最后添加 2888心跳端口 3888选举端口
     server.1=node1:2888:3888
     server.2=node2:2888:3888
     server.3=node3:2888:3888
     ```

   * myid

     ```shell
     #在每台机器的dataDir指定的目录下创建一个文件 名字叫做myid
     #myid里面的数字就是该台机器上server编号。server.N  N的数字就是编号
     [root@node1 conf]# mkdir -p /export/data/zkdata
     [root@node1 conf]# echo 1 >/export/data/zkdata/myid
     ```

     

   3. 把安装包同步到其他节点上

      ```shell
      cd /export/server
      scp -r zookeeper/ node2:$PWD
      scp -r zookeeper/ node3:$PWD
      ```

      

   4. 创建其他机器上的myid和datadir目录

      ```shell
      [root@node2 ~]# mkdir -p /export/data/zkdata
      [root@node2 ~]# echo 2 > /export/data/zkdata/myid 
      
      [root@node3 ~]# mkdir -p /export/data/zkdata
      [root@node3 ~]# echo 3 > /export/data/zkdata/myid 
      ```

   5. 每台机器上单独启动服务

      ```
      #在哪个目录执行启动命令 默认启动日志就生成当前路径下 叫做zookeeper.out
      
      /export/server/zookeeper/bin/zkServer.sh  start|stop|status
      
      #3台机器启动完毕之后 可以使用status查看角色是否正常。
      #还可以使用jps命令查看zk进程是否启动。
      [root@node3 ~]# jps
      2034 Jps
      1980 QuorumPeerMain  #zk的java进程
      ```

      

#### 附:一键启动脚本

```shell
[root@node1 ~]# vim startZk.sh
  
#!/bin/bash
hosts=(node1 node2 node3)
for host in ${hosts[*]}
do
 ssh $host "source /etc/profile;/export/server/zookeeper/bin/zkServer.sh start"
done
```

**一键关闭脚本**

```shell
[root@node1 ~]# vim stopZk.sh
  
#!/bin/bash
hosts=(node1 node2 node3)
for host in ${hosts[*]}
do
 ssh $host "/export/server/zookeeper/bin/zkServer.sh stop"
done
```

- - - 注意：关闭java进程时候 根据进程号 直接杀死即可就可以关闭。启动java进程的时候 需要JDK。

    - shell程序ssh登录的时候不会自动加载/etc/profile 需要shell程序中自己加载。

  - 作业：尝试使用一个脚本 实现zookeeper的启动、关闭、状态查看。 

---

## 

